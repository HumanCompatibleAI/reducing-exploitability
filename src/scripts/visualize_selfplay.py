from collections import defaultdict

import wandb
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

from scripts.stylesheets import setup_styles

api = wandb.Api()

# run = api.run("chaiberkeley/pbrl-defense-icml/seqb62s8")
#
# print(run.config)
# print(run.history())
# print(run.summary)

runs = api.runs(
    path="chaiberkeley/pbrl-defense-icml",
    filters={"config.wandb_group": "icml-selfplay-v2-push"},
)

df = pd.DataFrame()
counter = defaultdict(int)
for i, run in enumerate(runs):
    print(run.summary)
    history = run.scan_history()
    reward_0 = []
    reward_1 = []
    for row in history:
        if "policy_0_reward" in row:
            reward_0.append((row["timestep"], row["policy_0_reward"]))
            counter[row["timestep"]] += 1
        if "policy_1_reward" in row:
            reward_1.append((row["timestep"], row["policy_1_reward"]))
    df = df.append(pd.DataFrame(reward_0, columns=["timestep", f"reward_0"]))

counter_counter = defaultdict(int)
for ts, count in counter.items():
    counter_counter[count] += 1

print(counter_counter)

with setup_styles(["paper", "training-curve-1col-tall-legend"]):
    sns.lineplot(
        x="timestep", y="value", ci="sd", hue="variable", data=pd.melt(df, ["timestep"])
    )
    plt.show()
    # fig = plt.figure(figsize=(10, 5))
    # plt.savefig("selfplay-v2-push.png")
